import React, { useState, useMemo } from 'react';
import { 
  AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, 
  ResponsiveContainer, ComposedChart
} from 'recharts';
import { 
  Zap, TrendingUp, Lock, Calculator, 
  ArrowRightLeft, Info, ChevronRight,
  Download, Share2, Plus
} from 'lucide-react';

const App = () => {
  // 2025 actuals imported from financial records
  const initialBaseCost = 1887701.34; 
  
  // State for Scenario A (Primary / Conservative)
  const [annualIncreaseA, setAnnualIncreaseA] = useState(7.5);
  // State for Scenario B (Comparison / Aggressive)
  const [annualIncreaseB, setAnnualIncreaseB] = useState(10.5);
  const [isComparisonMode, setIsComparisonMode] = useState(false);
  const [startYear] = useState(2026);

  // Formatting utility with safety fallback
  const formatCurrency = (val) => {
    if (typeof val !== 'number' || isNaN(val)) return 'R 0';
    try {
      return new Intl.NumberFormat('en-ZA', {
        style: 'currency',
        currency: 'ZAR',
        maximumFractionDigits: 0,
      }).format(val);
    } catch (e) {
      return `R ${val.toLocaleString()}`;
    }
  };

  // Calculation engine for 10-year compounding with safety guards
  const projectionData = useMemo(() => {
    const data = [];
    let accumulationA = 0;
    let accumulationB = 0;
    let currentCostA = initialBaseCost;
    let currentCostB = initialBaseCost;

    // Ensure we have valid numbers for calculation
    const rateA = Number.isNaN(annualIncreaseA) ? 0 : annualIncreaseA;
    const rateB = Number.isNaN(annualIncreaseB) ? 0 : annualIncreaseB;

    for (let i = 0; i < 10; i++) {
      const year = startYear + i;
      
      // Scenario A
      const incA = currentCostA * (rateA / 100);
      const endA = currentCostA + incA;
      accumulationA += endA;

      // Scenario B
      const incB = currentCostB * (rateB / 100);
      const endB = currentCostB + incB;
      accumulationB += endB;

      data.push({
        year,
        scenarioA: Math.round(endA),
        scenarioB: Math.round(endB),
        accA: Math.round(accumulationA),
        accB: Math.round(accumulationB),
        annualDiff: Math.round(endB - endA),
        totalDiff: Math.round(accumulationB - accumulationA),
        growthRateA: rateA,
        growthRateB: rateB,
      });

      currentCostA = endA;
      currentCostB = endB;
    }
    return data;
  }, [annualIncreaseA, annualIncreaseB, startYear]);

  const stats = useMemo(() => {
    if (!projectionData || projectionData.length === 0) return { totalA: 0, totalB: 0, variance: 0, percentageIncrease: "0.0" };
    
    const last = projectionData[projectionData.length - 1];
    const totalA = last.accA || 0;
    const totalB = last.accB || 0;
    const variance = last.totalDiff || 0;
    const percentageIncrease = totalA > 0 ? ((totalB / totalA - 1) * 100).toFixed(1) : "0.0";

    return { totalA, totalB, variance, percentageIncrease };
  }, [projectionData]);

  // Custom Tooltip for professional charting
  const CustomTooltip = ({ active, payload, label }) => {
    if (active && payload && payload.length) {
      return (
        <div className="bg-[#0d1117] border border-slate-700 p-4 rounded-xl shadow-2xl backdrop-blur-md">
          <p className="text-slate-400 font-bold mb-2 uppercase tracking-widest text-[10px]">{label} Forecast</p>
          <div className="space-y-2">
            <div className="flex justify-between gap-8 items-center">
              <span className="text-xs text-yellow-500 flex items-center gap-2">
                <div className="w-2 h-2 rounded-full bg-yellow-500" /> Scenario A:
              </span>
              <span className="text-xs font-mono font-bold text-white">{formatCurrency(payload[0].value)}</span>
            </div>
            {isComparisonMode && payload[1] && (
              <div className="flex justify-between gap-8 items-center pt-2 border-t border-slate-800">
                <span className="text-xs text-cyan-400 flex items-center gap-2">
                  <div className="w-2 h-2 rounded-full bg-cyan-400" /> Scenario B:
                </span>
                <span className="text-xs font-mono font-bold text-white">{formatCurrency(payload[1].value)}</span>
              </div>
            )}
          </div>
        </div>
      );
    }
    return null;
  };

  return (
    <div className="min-h-screen bg-[#0a0e12] text-slate-200 p-4 md:p-8 font-sans selection:bg-yellow-500/30">
      <div className="max-w-7xl mx-auto">
        {/* Nav / Toolbar */}
        <nav className="flex justify-between items-center mb-12 py-2 border-b border-slate-800/50">
          <div className="flex items-center gap-2 text-[10px] font-black uppercase tracking-[0.3em] text-slate-500">
            <Calculator size={12} /> Analytical Suite / V4.2
          </div>
          <div className="flex gap-3">
            <button className="p-2 text-slate-500 hover:text-white transition-colors cursor-not-allowed"><Download size={16}/></button>
            <button className="p-2 text-slate-500 hover:text-white transition-colors cursor-not-allowed"><Share2 size={16}/></button>
          </div>
        </nav>

        {/* Header Section */}
        <header className="flex flex-col lg:row-span-1 lg:flex-row justify-between items-start lg:items-end gap-6 mb-12">
          <div className="space-y-2">
            <div className="flex items-center gap-3">
              <div className="p-2.5 bg-yellow-500/10 rounded-xl ring-1 ring-yellow-500/20">
                <Zap className="text-yellow-500 w-6 h-6" />
              </div>
              <h1 className="text-4xl font-bold tracking-tight text-white">Cost Projection Analysis</h1>
            </div>
            <p className="text-slate-400 text-sm max-w-xl leading-relaxed">
              Strategic forecasting model visualizing cumulative utility liabilities over a decadal horizon. 
              Calibrated against <span className="text-white font-medium">2025 actual expenditure.</span>
            </p>
          </div>

          <div className="flex flex-wrap gap-4 w-full lg:w-auto">
             <div className="bg-[#151b23] border border-slate-800 p-5 rounded-2xl shadow-xl flex-1 lg:flex-none min-w-[220px]">
              <span className="text-[10px] text-slate-500 font-bold uppercase tracking-widest block mb-2">
                Projected 10yr Total (A)
              </span>
              <div className="text-3xl font-mono font-bold text-yellow-500 flex items-baseline gap-1">
                <span className="text-sm font-sans mr-1">R</span>
                {(stats.totalA / 1000000).toFixed(2)}M
              </div>
            </div>

            {isComparisonMode && (
              <div className="bg-[#151b23] border border-cyan-500/20 p-5 rounded-2xl shadow-xl flex-1 lg:flex-none min-w-[220px] animate-in fade-in slide-in-from-right-4 duration-500">
                <span className="text-[10px] text-cyan-400 font-bold uppercase tracking-widest block mb-2">
                  10yr Delta (B-A)
                </span>
                <div className="text-3xl font-mono font-bold text-cyan-400 flex items-baseline gap-1">
                  <span className="text-sm font-sans mr-1">+ R</span>
                  {(stats.variance / 1000000).toFixed(2)}M
                </div>
              </div>
            )}
          </div>
        </header>

        <div className="grid grid-cols-1 lg:grid-cols-4 gap-8">
          {/* Sidebar Controls */}
          <div className="lg:col-span-1 space-y-6">
            <div className="bg-[#151b23] border border-slate-800 rounded-3xl overflow-hidden shadow-2xl shadow-black/50">
              <div className="p-6 border-b border-slate-800 bg-slate-800/20 flex items-center justify-between">
                <h3 className="flex items-center gap-2 text-xs font-bold text-slate-300 uppercase tracking-widest">
                  Parameters
                </h3>
                <TrendingUp size={14} className="text-slate-500" />
              </div>
              
              <div className="p-6 space-y-8">
                {/* Base Data */}
                <div>
                  <label className="text-[10px] font-bold text-slate-500 uppercase block mb-3">2025 Base Cost (Compounded)</label>
                  <div className="flex items-center justify-between bg-[#0d1117] p-4 rounded-xl border border-slate-800">
                    <span className="text-sm font-mono text-white">{formatCurrency(initialBaseCost)}</span>
                    <Lock size={12} className="text-slate-600" />
                  </div>
                </div>

                {/* Scenario A Slider */}
                <div className="space-y-4">
                  <div className="flex justify-between items-center">
                    <label className="text-[10px] font-bold text-yellow-500 uppercase tracking-tighter">Scenario A (Est. Growth)</label>
                    <span className="text-xs font-mono font-bold bg-yellow-500/10 text-yellow-500 px-2 py-1 rounded-md border border-yellow-500/20">{annualIncreaseA}%</span>
                  </div>
                  <input 
                    type="range" min="0" max="25" step="0.1"
                    value={annualIncreaseA}
                    onChange={(e) => setAnnualIncreaseA(parseFloat(e.target.value))}
                    className="w-full h-1.5 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-yellow-500 hover:accent-yellow-400 transition-all"
                  />
                  <div className="flex justify-between text-[9px] text-slate-600 font-bold uppercase">
                    <span>Low</span>
                    <span>Industry Avg</span>
                    <span>High</span>
                  </div>
                </div>

                {/* Comparison Logic */}
                <div className="pt-6 border-t border-slate-800">
                  <button 
                    onClick={() => setIsComparisonMode(!isComparisonMode)}
                    className={`w-full flex items-center justify-center gap-2 py-3 px-4 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all ${
                      isComparisonMode 
                      ? 'bg-cyan-500/10 text-cyan-400 border border-cyan-500/20 shadow-[0_0_15px_rgba(34,211,238,0.1)]' 
                      : 'bg-slate-800 text-slate-400 hover:bg-slate-700 hover:text-white'
                    }`}
                  >
                    <ArrowRightLeft size={14} />
                    {isComparisonMode ? 'Lock Comparison' : 'Run Differential'}
                  </button>
                </div>

                {/* Scenario B Slider */}
                {isComparisonMode && (
                  <div className="space-y-4 pt-6 border-t border-slate-800/50 animate-in slide-in-from-top-4 duration-300">
                    <div className="flex justify-between items-center">
                      <label className="text-[10px] font-bold text-cyan-400 uppercase tracking-tighter">Scenario B (Aggressive)</label>
                      <span className="text-xs font-mono font-bold bg-cyan-500/10 text-cyan-400 px-2 py-1 rounded-md border border-cyan-500/20">{annualIncreaseB}%</span>
                    </div>
                    <input 
                      type="range" min="0" max="25" step="0.1"
                      value={annualIncreaseB}
                      onChange={(e) => setAnnualIncreaseB(parseFloat(e.target.value))}
                      className="w-full h-1.5 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-cyan-400 hover:accent-cyan-300 transition-all"
                    />
                  </div>
                )}
              </div>
            </div>

            {/* Context Widget */}
            <div className="bg-[#151b23] border border-slate-800 p-5 rounded-3xl space-y-3">
              <div className="flex items-center gap-2 text-blue-400 mb-1">
                <Info size={14} />
                <span className="text-[10px] font-black uppercase tracking-widest">Projection Note</span>
              </div>
              <p className="text-[11px] text-slate-400 leading-relaxed italic">
                Results include <span className="text-slate-300">annual compounding interest</span>. Current market volatility suggests a 
                variance range of Â±1.2% in actual year-on-year adjustments.
              </p>
            </div>
          </div>

          {/* Visualization & Reporting */}
          <div className="lg:col-span-3 space-y-8">
            {/* Primary Chart */}
            <div className="bg-[#151b23] border border-slate-800 p-8 rounded-3xl shadow-sm relative overflow-hidden">
              <div className="absolute top-0 right-0 w-64 h-64 bg-yellow-500/5 rounded-full blur-[100px] -translate-y-1/2 translate-x-1/2" />
              
              <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-4">
                <h3 className="text-sm font-bold flex items-center gap-2 text-white uppercase tracking-widest">
                  10-Year Liability Curve
                </h3>
                <div className="flex flex-wrap gap-4 text-[9px] font-black uppercase tracking-[0.2em]">
                  <div className="flex items-center gap-2 px-3 py-1.5 rounded-full bg-yellow-500/10 text-yellow-500 border border-yellow-500/20">
                    <div className="w-1.5 h-1.5 rounded-full bg-yellow-500 shadow-[0_0_8px_#eab308]" /> Scenario A
                  </div>
                  {isComparisonMode && (
                    <div className="flex items-center gap-2 px-3 py-1.5 rounded-full bg-cyan-500/10 text-cyan-400 border border-cyan-400/20 animate-in fade-in zoom-in-95">
                      <div className="w-1.5 h-1.5 rounded-full bg-cyan-400 shadow-[0_0_8px_#22d3ee]" /> Scenario B
                    </div>
                  )}
                </div>
              </div>
              
              <div className="h-[400px] w-full">
                <ResponsiveContainer width="100%" height="100%">
                  <AreaChart data={projectionData} margin={{ top: 10, right: 10, left: 0, bottom: 0 }}>
                    <defs>
                      <linearGradient id="gradA" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="5%" stopColor="#eab308" stopOpacity={0.15}/>
                        <stop offset="95%" stopColor="#eab308" stopOpacity={0}/>
                      </linearGradient>
                      <linearGradient id="gradB" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="5%" stopColor="#22d3ee" stopOpacity={0.15}/>
                        <stop offset="95%" stopColor="#22d3ee" stopOpacity={0}/>
                      </linearGradient>
                    </defs>
                    <CartesianGrid strokeDasharray="4 4" stroke="#1e293b" vertical={false} />
                    <XAxis 
                      dataKey="year" 
                      stroke="#475569" 
                      fontSize={11} 
                      tickLine={false} 
                      axisLine={false}
                      dy={15}
                    />
                    <YAxis 
                      stroke="#475569" 
                      fontSize={11} 
                      tickLine={false} 
                      axisLine={false}
                      tickFormatter={(val) => `R${(val/1000).toFixed(0)}k`}
                    />
                    <Tooltip 
                      content={<CustomTooltip />}
                      cursor={{ stroke: '#334155', strokeWidth: 1 }}
                    />
                    <Area 
                      type="monotone" 
                      dataKey="scenarioA" 
                      stroke="#eab308" 
                      strokeWidth={4}
                      fillOpacity={1} 
                      fill="url(#gradA)" 
                      animationDuration={1500}
                    />
                    {isComparisonMode && (
                      <Area 
                        type="monotone" 
                        dataKey="scenarioB" 
                        stroke="#22d3ee" 
                        strokeWidth={4}
                        fillOpacity={1} 
                        fill="url(#gradB)" 
                        animationDuration={1500}
                      />
                    )}
                  </AreaChart>
                </ResponsiveContainer>
              </div>
            </div>

            {/* Reporting Table */}
            <div className="bg-[#151b23] border border-slate-800 rounded-3xl overflow-hidden shadow-2xl">
              <div className="overflow-x-auto">
                <table className="w-full text-left text-[11px] border-collapse">
                  <thead>
                    <tr className="bg-slate-800/40 text-slate-500 border-b border-slate-800">
                      <th className="p-5 font-bold uppercase tracking-widest">Year Index</th>
                      <th className="p-5 font-bold uppercase tracking-widest text-yellow-500/80">Scenario A</th>
                      {isComparisonMode && <th className="p-5 font-bold uppercase tracking-widest text-cyan-400">Scenario B</th>}
                      <th className="p-5 font-bold uppercase tracking-widest text-right">Running Total (A)</th>
                      {isComparisonMode && <th className="p-5 font-bold uppercase tracking-widest text-right text-cyan-400 underline decoration-cyan-400/30 underline-offset-4">Liability Var</th>}
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-800/50">
                    {projectionData.map((row, idx) => (
                      <tr key={row.year} className="hover:bg-slate-800/20 transition-colors group">
                        <td className="p-5 font-bold text-slate-300">
                          <div className="flex items-center gap-3">
                             <span className="w-5 h-5 flex items-center justify-center rounded bg-slate-800 text-[9px] text-slate-500 group-hover:bg-yellow-500 group-hover:text-black transition-all">
                               {idx + 1}
                             </span>
                             {row.year}
                          </div>
                        </td>
                        <td className="p-5 font-mono text-slate-300">{formatCurrency(row.scenarioA)}</td>
                        {isComparisonMode && <td className="p-5 font-mono text-cyan-400/70">{formatCurrency(row.scenarioB)}</td>}
                        <td className="p-5 text-right font-mono font-bold text-slate-400">{formatCurrency(row.accA)}</td>
                        {isComparisonMode && (
                          <td className="p-5 text-right font-mono font-bold text-red-400/90 bg-red-400/5 group-hover:bg-red-400/10 transition-colors">
                            + {formatCurrency(row.totalDiff)}
                          </td>
                        )}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        {/* Action / Warning Bar */}
        <div className="mt-12 flex flex-col md:flex-row gap-6 p-8 bg-[#151b23] border border-slate-800 rounded-3xl items-center justify-between">
          <div className="flex gap-4 items-center">
            <div className="p-3 bg-red-500/10 rounded-2xl ring-1 ring-red-500/20">
              <TrendingUp className="text-red-500" />
            </div>
            <div>
              <p className="text-sm font-bold text-white">Aggressive Scenario Alert</p>
              <p className="text-xs text-slate-400">Comparing Scenarios results in a <span className="text-red-400 font-bold">{stats.percentageIncrease}% variance</span> in total liability.</p>
            </div>
          </div>
          <button 
            disabled
            className="px-6 py-3 bg-slate-800 rounded-2xl text-[10px] font-black uppercase tracking-widest text-slate-500 cursor-not-allowed border border-slate-700"
          >
            Review Audit Log
          </button>
        </div>
      </div>
    </div>
  );
};

export default App;